<!DOCTYPE html>
<html>

<head>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
		integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
		crossorigin="anonymous"></script>
	<meta charset="utf-8">
	<title>Rivers guidebook</title>
	<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
	<link href="https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.css" rel="stylesheet">
	<script src="https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.js"></script>
	<style>
		body {
			margin: 0;
			padding: 0;
		}

		#map {
			position: absolute;
			top: 0;
			bottom: 0;
			width: 100%;
			height: 100%;
		}

		.map-wrapper {
			position: relative;
			width: 100%;
			min-height: 50vh;
			height: 500px
		}

		.mapboxgl-popup {
			max-width: 400px;
			font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
		}
	</style>
</head>

<body>
	<div class="container">
		<div class="p-5 mb-4 bg-light rounded-3">
			<div class="container-fluid py-5">
				<h1 class="display-5 fw-bold">UK Rivers</h1>
				<p class="col-md-8 fs-4">An online guidebook for UK rivers where you can log paddles and take notes on rivers.</p>
				<a class="btn btn-primary btn-lg" type="button" href="/river/new/"> Create new river</a>
			</div>
		</div>
		<div class="row">
			<div class="map-wrapper">
				<div id="map"></div>
			</div>
		</div>
	</div>
	<script>
		geojson = {{ riverFeatureCollection | safe }}
		mapboxgl.accessToken = 'pk.eyJ1IjoiYmJyb2FkYmVudCIsImEiOiJja3h6NXg0amQwejZrMnZycWFoMzdqamw4In0.kHyw2aXXCufJOSxecvKCnQ';
		const map = new mapboxgl.Map({
			container: 'map', // container ID
			style: 'mapbox://styles/mapbox/streets-v11', // style URL
			center: [-2.3, 52.6], // starting position [lng, lat]
			zoom: 6 // starting zoom
		});

		map.on('load', () => {
			// Add a data source containing GeoJSON data.
			map.addSource('rivers', {
				'type': 'geojson',
				'data': geojson
			});

			map.addLayer({
				'id': 'riversLayer',
				'type': 'line',
				'source': 'rivers',
				'layout': {
					'line-join': 'round',
					'line-cap': 'round'
				},
				'paint': {
					'line-color': '#3477eb',
					'line-width': 3
				}
			});

			map.on('click', 'riversLayer', (e) => {
				console.log('click')
				// Copy coordinates array.
				const coordinates = e.lngLat;
				const description = `<a href=/river/${e.features[0].properties.riverID}>${e.features[0].properties.riverName}</a>`;

				// Ensure that if the map is zoomed out such that multiple
				// copies of the feature are visible, the popup appears
				// over the copy being pointed to.
				while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
					coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
				}

				new mapboxgl.Popup()
					.setLngLat(coordinates)
					.setHTML(description)
					.addTo(map);
			});
			// Change the cursor to a pointer when the mouse is over the places layer.
			map.on('mouseenter', 'riversLayer', () => {
				map.getCanvas().style.cursor = 'pointer';
			});

			// Change it back to a pointer when it leaves.
			map.on('mouseleave', 'riversLayer', () => {
				map.getCanvas().style.cursor = '';
			});

		});
	</script>
</body>

</html>